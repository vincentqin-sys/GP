<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交割单</title>
    <style type="text/css">
        body {
            background-color: rgb(0, 0, 0);
            width: 1920px;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
        #jgd_table {
            border-collapse : collapse;
            border: 1px solid black;
            width: 800px;
            max-height: 700px;
            overflow: auto;
            cursor: default;
        }
        #jgd_table th {
            background-color: #edf7ff;
            border: solid 1px #222;
            text-align: left;
        }
        table > tbody > tr:hover {
            background-color: #e3ecfc;
        }
        table tbody tr:nth-child(odd) {
            background-color: #fff;
        }
        table tbody tr:nth-child(even) {
            background-color: #f7f7f7;
        }
        table tbody tr.sel {
            background-color: #d8b1e4;
        }
        .period {
            background-color: #ccc;
        }
        .zoom {
            background-color: #ccc;
            height: 23px;
        }
        button.sel {
            background-color: #d8b1e4;
        }
        table.ops{
            border-collapse : collapse;
            border: 0;
            margin-top: 10px;
        }
        .ops th {
            background-color: #edf7ff;
            text-align: left;
            padding-left: 5px;
        }
    </style>
    <script type="text/javascript" src="jquery-3.6.min.js"></script>
</head>

<body>
    <div style="padding-left: 70px;">
        <button onclick="changePeriod('day')" class="period"> 日线 </button> &nbsp; <button onclick="changePeriod('week')" class="period"> 周线 </button>
        <button onclick="zoom('+')" class="zoom"> + </button> &nbsp; <button onclick="zoom('-')" class="zoom"> - </button>
        &nbsp;&nbsp;&nbsp;<button onclick="changeFuQuan(this)" > 复权 </button>
    </div>

    <div id="chart" width="1300" height="900" style="float:left;" style="overflow: hidden;">
        <canvas id="canvas" height="700" width="1400" style="width: 1400px; height: 700px; border: solid 1px #fff;">
        </canvas>
        <div id="news">  </div>
    </div>

    <div style="float: left; background-color: #fafafa; width:500px; height: 900px; margin-left: 5px; overflow: auto;">
        <div>
            交割单
            <table id="jgd_table"> 
                <thead><tr><th width="40"> # </th> <th width="75"> 名称 </th> 
                    <th width="85"> 买日期</th>
                     <th width="85"> 卖日期 </th> <th> 备注 </th></tr></thead>
                <tbody> </tbody>
            </table>
        </div>
        <div>
            <table class="ops">
            <tr>
                <input id="id" type="hidden" value=""/>
                <th>代&nbsp;&nbsp;&nbsp;码：</th> <td> <input type="text" id="code" style="width: 100%;"> </input></td>
                <th>名称：</th> <td> <input type="text" id="name" style="width: 100%"> </input> </td>
            </tr>
            <tr>
            <th>买日期：</th> <td> <input type="text" id="buyDay" style="width: 100%"> </input></td>
            <th>买价：</th> <td> <input type="text" id="buyPrice" style="width: 100%"> </input> </td>
            </tr>
            <tr>
            <th>卖日期：</th> <td>  <input type="text" id="sellDay" style="width: 100%"> </input></td>
            <th>卖价：</th> <td>  <input type="text" id="sellPrice" style="width: 100%"> </input></td>
            </tr>
            <tr><th>备&nbsp;&nbsp;注：</th> <td colspan="4">   <input type="text" id="remark" style="width: 100%;"> </input> </td> </tr>
            <tr><td colspan="4" style="text-align: center;">
                <button id="updateBtn" onclick="update()"> 更新 </button> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <button id="insertBtn" onclick="insert()"> 新增 </button> </td>
            </tr>
            <tr> <td style="text-align: center; " id="ops_info" colspan="4">  </td> </tr>
            </table>
        </div>
    </div>
</body>

<script>
    ctrlParams = {
        period : 'day',
        fuQuan : 'FQ', // FQ  CQ LASTEST
        loadKMaxNum: 180,
    };
    jgdArr = [];
    dataArr = [];
    curJGD = null;
    loadKMaxNum = 180;
    const MAX_K_NUM_MAP ={1 : 500, 2: 400, 3: 300, 4: 250, 5: 180, 6: 150, 7: 130, 8: 120};

    function getCode() {
        return curJGD ? curJGD.code : '';
    }
    function getPeriod() {
        return ctrlParams.period;
    }
    function getCurJGD() {
        return curJGD;
    }
    function changeFuQuan(obj) {
        if (! getCurJGD()) {
            return;
        }
        let fuQuan = ctrlParams.fuQuan;
        if (fuQuan == 'FQ') {
            obj.innerText = '不复权';
            ctrlParams.fuQuan = 'CQ';
        } else if (fuQuan == 'CQ') {
            obj.innerText = '最新';
            ctrlParams.fuQuan = 'LASTEST';
        } else {
            obj.innerText = '复权';
            ctrlParams.fuQuan = 'FQ';
        }
        load(curJGD.code, curJGD.buyDay, getPeriod());
    }
    function zoom(op) {
        if (! curJGD) {
            return;
        }
        let old = K_WIDTH;
        if (op == '+') {
            K_WIDTH += 2;
            if (K_WIDTH > 8) {
                K_WIDTH = 8;
            }
        } else {
            K_WIDTH -= 2;
            if (K_WIDTH < 1)
                K_WIDTH = 1;
        }
        
        if (old != K_WIDTH) {
            load(curJGD.code, curJGD.buyDay, getPeriod());
        }
    }
</script>

<script>
    function load(code, day, period) {
        let mm = MAX_K_NUM_MAP[K_WIDTH];
        let url = 'http://localhost:8055/load_code?code=' + code + '&day=' + day + "&period=" + period + "&maxNum=" + mm + '&fuQuan=' + ctrlParams.fuQuan;
        console.log(url);
        $.get(url, function (data) {
            ctrlParams.period = period;
            dataArr = JSON.parse(data);
            let ps = $('.period').removeClass('sel');
            if (period == 'day') {
                $(ps[0]).addClass('sel');
            } else {
                $(ps[1]).addClass('sel');
            }
            resetGraph();
        });
    }

    // period = 'day' or 'week'
    function changePeriod(period) {
        if (curJGD) {
            let ps = $('.period').removeClass('sel');
            if (period == 'day') {
                $(ps[0]).addClass('sel');
            } else {
                $(ps[1]).addClass('sel');
            }
            load(curJGD.code, curJGD.buyDay, period);
        }
    }

    function setInputValues(jgd) {
        let ids = ['id', 'code', 'name', 'buyDay', 'buyPrice', 'sellDay', 'sellPrice', 'remark']
        for (let i = 0; i < ids.length; ++i) {
            if (jgd) {
                $('#' + ids[i]).val(jgd[ids[i]]);
            } else {
                $('#' + ids[i]).val('');
            }
        }
    }

    function showTip(success, txt) {
        let x = document.getElementById('ops_info');
        if (success) {
            x.innerHTML = '<span style="color: green;" >' + txt + "</span>" ;
        } else {
            x.innerHTML = '<span style="color: red;" >' + txt + "</span>";
        }
        setTimeout(function () {
            x.innerHTML = '';
        }, (success ? 4000 : 15000));
    }

    function update() {
        if (! $('#id').val()) {
            showTip(false, "非存储数据，不能更新!");
            return;
        }
        let params = {};
        let ids = ['id', 'code', 'name', 'buyDay', 'buyPrice', 'sellDay', 'sellPrice', 'remark'];
        for (let i = 0; i < ids.length; ++i) {
            let k = ids[i];
            let v = $('#' + k).val().trim();
            params[k] = v;
        }

        $.ajax({url: 'http://localhost:8055/update_jgd', data: JSON.stringify(params), method:'post', dataType:'json', contentType:'application/json',
         success: function (data) {
            console.log(data);
            let json = data;
            let trs = $('#jgd_table tbody tr');
            for (let i = 0; i < jgdArr.length; ++i) {
                if (jgdArr[i].id == json.data.id) {
                    jgdArr[i] = json.data;
                    let ids = ['name', 'buyDay', 'sellDay', 'remark']
                    let tr = trs.eq(i);
                    let tds = tr.children('td');
                    for (let m = 1; m < tds.length; ++m) {
                        tds.eq(m).empty();
                        tds.eq(m).append(json.data[ids[m - 1]]);
                    }
                    break;
                }
            }
            showTip(json.status == 'OK', json.info);
        }});
    }

    function insert() {
        if ($('#id').val()) {
            setInputValues(null);
            return;
        }
        let params = {};
        let ids = ['code', 'name', 'buyDay', 'buyPrice', 'sellDay', 'sellPrice', 'remark']
        for (let i = 0; i < ids.length; ++i) {
            let k = ids[i];
            let v = $('#' + k).val().trim();
            params[k] = v;
        }
        if (! params['code'] || ! params['name']) {
            showTip(false, '代码、名称不能为空!');
            return;
        }

        $.ajax({
            url: 'http://localhost:8055/insert_jgd', data: JSON.stringify(params), method: 'post', dataType: 'json', contentType: 'application/json',
            success: function (data) {
                console.log(data);
                let json = data;
                jgdArr.push(json.data);
                showTip(json.status == 'OK', json.info);

                let ids = ['name', 'buyDay', 'sellDay', 'remark']
                let tr = $('<tr> </tr>');
                tr.append('<td>' + jgdArr.length + '</td>');
                for (let m = 1; m < ids.length; ++m) {
                    tr.append('<td>' + json.data[ids[m - 1]] + '</td>');
                }
                $('#jgd_table tbody').append(tr);
                tr.dblclick(selectRow);
                setInputValues(null);
        }});
    }

    function selectRow() {
        let tr = $(this);
        let idx = parseInt(tr.children('td')[0].innerText);
        let jgd = jgdArr[idx - 1];
        // console.log('idx=', idx, 'jgd=', jgd);

        let old = $('table tr.sel');
        old.removeClass('sel');
        old.addClass(idx % 2 ? 'even' : 'odd');
        tr.removeClass('even odd');
        tr.addClass('sel');
        curJGD = jgd;
        setInputValues(jgd);
        load(curJGD.code, curJGD.buyDay, 'day');
    }

    $(function() {
        $.get('http://localhost:8055/load_jgd', function (data) {
            jgdArr = JSON.parse(data);
            console.log(jgdArr);
            let tb = $('#jgd_table > tbody');
            for (let i = 0; i < jgdArr.length; ++i) {
                let jgd = jgdArr[i];
                let ss = '<tr>' + '<td>' + (i + 1) + '</td>' + ('<td>' + jgd.name + '</td>') +  ('<td>' + jgd.buyDay + '</td>') +
                    ('<td>' + jgd.sellDay + '</td>') + ('<td>' + jgd.remark + '</td>') + '</tr>';
                tb.append(ss);
            }
            $('#jgd_table tbody tr').dblclick(selectRow);
        });
    });
</script>

<script type="text/javascript" src="draw.js"></script>

</html>